<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sanctions & PEP Compliance Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>

  <style>
:root {
  --bg: #eef3f7;
  --surface: #ffffff;
  --surface-soft: #f8fbfe;
  --surface-strong: #f1f6fb;
  --text: #0f172a;
  --muted: #475569;
  --muted-soft: #64748b;
  --primary: #0ea5e9;
  --primary-strong: #0284c7;
  --primary-soft: #e0f2fe;
  --success: #15803d;
  --warning: #b45309;
  --danger: #b91c1c;
  --border: rgba(148, 163, 184, 0.35);
  --ring: rgba(14, 165, 233, 0.25);
  --shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
  --radius-card: 18px;
  --radius-md: 12px;
  --radius-sm: 10px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font: 14px/1.5 Inter, "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
  color: var(--text);
  background: radial-gradient(circle at 0% 0%, rgba(14, 165, 233, 0.14), transparent 42%), var(--bg);
}

.wrap {
  max-width: 1080px;
  margin: 24px auto;
  padding: 0 16px;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-card);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.card .hd {
  padding: 18px 24px;
  background: linear-gradient(135deg, #0f172a 0%, #0b2840 60%, #0f3a58 100%);
  color: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.16);
}

.card .bd { padding: 24px; }

.logo-section { display: flex; align-items: center; gap: 14px; }

.logo-placeholder {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  font-weight: 800;
  letter-spacing: .02em;
  color: #0f172a;
  background: linear-gradient(140deg, #bae6fd 0%, #e0f2fe 100%);
  border: 1px solid rgba(255, 255, 255, 0.6);
}

.header-text h1 {
  font-size: 20px;
  margin: 0;
  font-weight: 700;
  letter-spacing: .01em;
}

.subtitle {
  margin-top: 2px;
  font-size: 12px;
  color: rgba(248, 250, 252, 0.78);
  text-transform: uppercase;
  letter-spacing: .08em;
  font-weight: 600;
}

.security-badge {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: #e2e8f0;
  border: 1px solid rgba(226, 232, 240, 0.35);
  background: rgba(15, 23, 42, 0.45);
  border-radius: 999px;
  padding: 7px 12px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 12px;
}

.col-2 { grid-column: span 2; }
.col-4 { grid-column: span 4; }

.form-group { margin-bottom: 0; }

label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  margin: 0 0 6px;
  text-transform: uppercase;
  letter-spacing: .06em;
}

input,
select {
  width: 100%;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 12px;
  outline: none;
  font-size: 14px;
  color: var(--text);
  background: var(--surface);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}

input::placeholder { color: var(--muted-soft); }

input:focus,
select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--ring);
}

.btns {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 4px;
}

button {
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 16px;
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  transition: all .15s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

button.primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
  border-color: transparent;
  color: #fff;
}

button.primary:hover {
  filter: brightness(.98);
  transform: translateY(-1px);
}

button:hover {
  background: var(--surface-soft);
  transform: translateY(-1px);
}

button:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px var(--ring);
}

button:disabled {
  opacity: .58;
  cursor: not-allowed;
  transform: none;
}

.status {
  margin-top: 8px;
  color: var(--muted);
  font-size: 13px;
  font-weight: 600;
}

.error { color: var(--danger); }
.success { color: var(--success); }

.user-info {
  background: linear-gradient(135deg, #eff6ff 0%, #e0f2fe 100%);
  border: 1px solid #bfdbfe;
  border-radius: var(--radius-md);
  padding: 14px;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 800;
  color: #fff;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
}

.report { margin-top: 22px; }

.report-header {
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 12px 12px 0 0;
  background: linear-gradient(135deg, #f8fbff 0%, #eef5fb 100%);
  padding: 18px 22px;
  position: relative;
}

.report-body {
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 12px 12px;
  background: var(--surface);
}

.report-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.report-title h2 {
  font-size: 19px;
  margin: 0;
  font-weight: 700;
}

.report-ref {
  background: #0f172a;
  color: #f8fafc;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 11px;
  font-weight: 700;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}

.report-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 12px;
  margin-top: 8px;
}

.meta-label {
  color: var(--muted-soft);
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .07em;
}

.meta-value {
  color: var(--text);
  font-weight: 700;
  font-size: 13px;
}

.section {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
}

.section:last-child { border-bottom: none; }

.section h3 {
  font-size: 15px;
  margin: 0 0 12px;
  font-weight: 700;
  color: #0f172a;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  padding: 5px 10px;
}

.status-clear { background: #dcfce7; color: #14532d; }
.status-match { background: #fee2e2; color: #7f1d1d; }
.status-review { background: #fef3c7; color: #78350f; }

.kv-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.kv-table th,
.kv-table td {
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.kv-table th {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .06em;
  background: var(--surface-strong);
}

.kv-table td {
  font-size: 13px;
}

.kv-table td.key {
  width: 220px;
  color: var(--muted);
  font-weight: 700;
  background: #fbfdff;
}

.kv-table tr:last-child th,
.kv-table tr:last-child td {
  border-bottom: none;
}

.match-list {
  margin-top: 8px;
  display: grid;
  gap: 10px;
}

.match-item {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #f8fbff;
  padding: 12px;
}

.match-score {
  float: right;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 11px;
  font-weight: 800;
  color: #7c2d12;
  background: #fed7aa;
}

.watermark {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-34deg);
  font-size: 72px;
  font-weight: 900;
  letter-spacing: .04em;
  color: rgba(2, 132, 199, 0.06);
  pointer-events: none;
  -webkit-user-select: none;
  user-select: none;
}

.sources-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.source-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 5px 10px;
  background: #fff;
  color: #1e293b;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .03em;
}

.source-chip svg {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  flex: 0 0 auto;
}

.mono {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}

@media (max-width: 980px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .col-2,
  .col-4 {
    grid-column: span 2;
  }

  .report-title {
    align-items: flex-start;
    flex-direction: column;
  }
}

@media (max-width: 700px) {
  .card .hd {
    align-items: flex-start;
    flex-direction: column;
    gap: 10px;
  }

  .grid,
  .report-meta {
    grid-template-columns: 1fr;
  }

  .col-2,
  .col-4 {
    grid-column: span 1;
  }

  .btns {
    display: grid;
    grid-template-columns: 1fr;
  }

  .kv-table td.key {
    width: 140px;
  }
}

@media print {
  .no-print { display: none !important; }

  body {
    margin: 0;
    background: #fff;
  }

  .card {
    border: none;
    box-shadow: none;
  }

  .watermark {
    color: rgba(2, 132, 199, 0.04);
  }
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="logo-section">
          <div class="logo-placeholder">SC</div>
          <div class="header-text">
            <h1>Sanctions & PEP Compliance Check</h1>
            <div class="subtitle">Screening Service</div>
          </div>
        </div>
        <div class="security-badge">Secure Session</div>
      </div>

      <div class="bd">
        <div class="user-info no-print" id="userInfo">
          <div class="user-avatar" id="userAvatar">?</div>
          <div>
            <strong>Authorized User:</strong> <span id="currentUserDisplay">Loading...</span><br>
            <small class="muted">Session Active</small>
          </div>
        </div>

        <div class="grid">
          <div class="col-2 form-group">
            <label for="name">Full name / Organisation *</label>
            <input id="name" placeholder="Enter individual or entity name" />
          </div>
          <div class="form-group">
            <label for="dob">Date of birth (optional)</label>
            <input id="dob" type="date" />
          </div>
          <div class="form-group">
            <label for="etype">Entity type</label>
            <select id="etype">
              <option value="Person">Individual Person</option>
              <option value="Organization">Organization/Entity</option>
            </select>
          </div>
          <div class="col-2 form-group">
            <label for="businessRef">Business reference *</label>
            <input id="businessRef" placeholder="e.g. CLAIM-12345" />
          </div>
          <div class="col-2 form-group">
            <label for="reasonForCheck">Reason for check *</label>
            <select id="reasonForCheck"></select>
          </div>
          <div class="col-4 btns no-print">
            <button class="primary" id="runBtn">Run Compliance Check</button>
            <button id="pdfBtn" disabled>Download Report</button>
            <button id="clearBtn">Clear Form</button>
          </div>
        </div>

        <div class="status" id="status"></div>

        <div class="report" id="report" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://sanctions-check.co.uk";
    const FLOW_URL = "";
    const DATA_SOURCES_TEXT = "United Nations; European Union; US OFAC; UK HM Treasury (OFSI)";
    const DEFAULT_REASON_FOR_CHECK = "Ad-Hoc Compliance Review";
    const REASON_FOR_CHECK_OPTIONS = [
      "Client Onboarding",
      "Claim Payment",
      "Business Partner Payment",
      "Business Partner Due Diligence",
      "Periodic Re-Screen",
      "Ad-Hoc Compliance Review",
    ];

    const ICONS = {
      UN: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="#009edb"/><circle cx="32" cy="32" r="14" fill="#fff"/><circle cx="32" cy="32" r="9" fill="#009edb"/></svg>`,
      EU: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#003399"/><g fill="#ffcc00">` +
          Array.from({length:12}).map((_,i)=> {
            const a = (i*30-90)*Math.PI/180, R=14, cx=32+R*Math.cos(a), cy=21+R*Math.sin(a);
            return `<polygon transform="translate(${cx},${cy})" points="0,-3 0.9,-0.9 3,0 0.9,0.9 0,3 -0.9,0.9 -3,0 -0.9,-0.9"/>`
          }).join("") + `</g></svg>`,
      US: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#b22234"/>` +
          Array.from({length:7}).map((_,i)=>`<rect y="${i*6}" width="64" height="3" fill="#fff"/>`).join("") +
          `<rect width="26" height="19" fill="#3c3b6e"/></svg>`,
      UK: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#012169"/><path d="M0,0 64,42 M64,0 0,42" stroke="#fff" stroke-width="8"/><path d="M0,0 64,42 M64,0 0,42" stroke="#C8102E" stroke-width="4"/><path d="M32,0 v42 M0,21 h64" stroke="#fff" stroke-width="12"/><path d="M32,0 v42 M0,21 h64" stroke="#C8102E" stroke-width="8"/></svg>`
    };

    let currentUser = null;
    let currentReport = null;

    const el = {
      name: document.getElementById("name"),
      dob: document.getElementById("dob"),
      etype: document.getElementById("etype"),
      businessRef: document.getElementById("businessRef"),
      reasonForCheck: document.getElementById("reasonForCheck"),
      runBtn: document.getElementById("runBtn"),
      pdfBtn: document.getElementById("pdfBtn"),
      clearBtn: document.getElementById("clearBtn"),
      status: document.getElementById("status"),
      report: document.getElementById("report"),
      currentUserDisplay: document.getElementById("currentUserDisplay"),
      userAvatar: document.getElementById("userAvatar"),
    };

    getCurrentUser();
    initRequiredFields();
    el.runBtn.addEventListener("click", runCheck);
    el.pdfBtn.addEventListener("click", downloadPDF);
    el.clearBtn.addEventListener("click", clearForm);

    function clearForm() {
      el.name.value = "";
      el.dob.value = "";
      el.etype.value = "Person";
      el.businessRef.value = generateDefaultBusinessReference();
      el.reasonForCheck.value = DEFAULT_REASON_FOR_CHECK;
      el.report.innerHTML = "";
      el.status.textContent = "";
      el.pdfBtn.disabled = true;
      currentReport = null;
    }

    function initRequiredFields() {
      if (el.reasonForCheck) {
        const optionsHtml = REASON_FOR_CHECK_OPTIONS
          .map((option) => `<option value="${option}">${option}</option>`)
          .join("");
        el.reasonForCheck.innerHTML = optionsHtml;
        el.reasonForCheck.value = DEFAULT_REASON_FOR_CHECK;
      }
      if (el.businessRef && !el.businessRef.value.trim()) {
        el.businessRef.value = generateDefaultBusinessReference();
      }
    }

    function generateDefaultBusinessReference() {
      const recordId = getDataverseRecordId();
      if (recordId) return recordId;
      return generateReference();
    }

    function getDataverseRecordId() {
      const x = getXrm();
      try {
        const id = x?.Page?.data?.entity?.getId?.();
        if (id) return String(id).replace(/[{}]/g, "");
      } catch {}
      return null;
    }

    function getXrm() {
      if (typeof Xrm !== "undefined" && Xrm.Utility) return Xrm;
      if (window.parent && window.parent.Xrm && window.parent.Xrm.Utility) return window.parent.Xrm;
      if (window.top && window.top.Xrm && window.top.Xrm.Utility) return window.top.Xrm;
      return null;
    }

    function waitForXrm(maxMs = 3000, step = 100) {
      return new Promise((resolve) => {
        const start = Date.now();
        (function poll() {
          const x = getXrm();
          if (x) return resolve(x);
          if (Date.now() - start >= maxMs) return resolve(null);
          setTimeout(poll, step);
        })();
      });
    }

    async function getCurrentUser() {
      try {
        const x = await waitForXrm();

        if (x && x.Utility && x.Utility.getGlobalContext) {
          const gc = x.Utility.getGlobalContext();
          const us = gc.userSettings || {};
          const clientUrl = (gc.getClientUrl && gc.getClientUrl()) || "";
          const rawId = (us.userId || "").replace(/[{}]/g, "");
          const fallbackName = us.userName || "Dataverse User";

          if (rawId && x.WebApi && x.WebApi.retrieveRecord) {
            try {
              const rec = await x.WebApi.retrieveRecord(
                "systemuser",
                rawId,
                "?$select=fullname,domainname,internalemailaddress,systemuserid"
              );
              currentUser = {
                fullname: rec.fullname || fallbackName,
                domainname: rec.domainname || "",
                email: rec.internalemailaddress || "",
                userid: rec.systemuserid || rawId,
                method: "Xrm.WebApi",
                clientUrl
              };
              updateUserDisplay();
              return currentUser;
            } catch (e) {
              console.warn("[user] Xrm.WebApi.retrieveRecord failed, fallback:", e);
            }
          }

          currentUser = {
            fullname: fallbackName,
            domainname: us.domainName || "",
            email: "",
            userid: rawId || (us.userId || ""),
            method: "Xrm.UserSettings",
            clientUrl
          };
          updateUserDisplay();
          return currentUser;
        }

        let orgUrl = "";
        try {
          const href = window.location.href;
          const m = href.match(/https:\/\/([^\/]+\.dynamics\.com)/) ||
                    href.match(/https:\/\/([^\/]+\.crm\d*\.dynamics\.com)/) ||
                    href.match(/https:\/\/([^\/]+)/);
          if (m) orgUrl = "https://" + m[1];
        } catch {}

        if (orgUrl) {
          const odataHeaders = {
            "Accept": "application/json",
            "Content-Type": "application/json; charset=utf-8",
            "OData-Version": "4.0",
            "OData-MaxVersion": "4.0"
          };

          const who = await fetch(`${orgUrl}/api/data/v9.2/WhoAmI`, {
            method: "GET",
            credentials: "include",
            headers: odataHeaders
          });

          if (who.ok) {
            const whoJson = await who.json();
            const userId = whoJson.UserId;
            const u = await fetch(`${orgUrl}/api/data/v9.2/systemusers(${userId})?$select=fullname,domainname,internalemailaddress,systemuserid`, {
              method: "GET",
              credentials: "include",
              headers: odataHeaders
            });
            if (u.ok) {
              const uj = await u.json();
              currentUser = {
                fullname: uj.fullname || "Dataverse User",
                domainname: uj.domainname || "",
                email: uj.internalemailaddress || "",
                userid: uj.systemuserid || userId,
                method: "REST",
                clientUrl: orgUrl
              };
              updateUserDisplay();
              return currentUser;
            }
          }
        }

        currentUser = {
          fullname: "Compliance Officer",
          domainname: "",
          email: "",
          userid: "system-user",
          method: "Fallback",
          clientUrl: ""
        };
        updateUserDisplay();
        return currentUser;
      } catch (err) {
        console.error("[user] unexpected error:", err);
        currentUser = {
          fullname: "System User",
          domainname: "",
          email: "",
          userid: "fallback-user",
          method: "Error-Fallback",
          clientUrl: ""
        };
        updateUserDisplay();
        return currentUser;
      }
    }

    function updateUserDisplay() {
      const name = currentUser?.fullname || "User";
      const dom = currentUser?.domainname ? ` (${currentUser.domainname})` : "";
      const avatar = name.charAt(0).toUpperCase();
      const elName = document.getElementById("currentUserDisplay");
      const elAvatar = document.getElementById("userAvatar");
      if (elName) elName.textContent = name + dom;
      if (elAvatar) elAvatar.textContent = avatar;
    }

    function getCurrentUserInfo() { return currentUser; }

    function generateReference() {
      const base = Math.floor(Date.now()/1000).toString(36).toUpperCase() + Math.random().toString(36).slice(2,6).toUpperCase();
      const hostCk = simpleHash(window.location.host).toString(36).toUpperCase().slice(0,2);
      return `${base}${hostCk}`;
    }

    function simpleHash(str) {
      let h = 0;
      for (let i=0;i<str.length;i++) { h = (h<<5) - h + str.charCodeAt(i); h |= 0; }
      return h >>> 0;
    }

    async function runCheck() {
      const name = el.name.value.trim();
      const dob = el.dob.value ? el.dob.value : null;
      const entity_type = el.etype.value;
      const business_reference = el.businessRef.value.trim();
      const reason_for_check = el.reasonForCheck.value;
      const user = getCurrentUserInfo();

      if (!name) { toast("Please enter a name to search.", true); return; }
      if (!business_reference) { toast("Please provide a business reference.", true); return; }
      if (!REASON_FOR_CHECK_OPTIONS.includes(reason_for_check)) { toast("Please select a valid reason for check.", true); return; }
      if (!user || !user.fullname) { toast("Unable to detect current user.", true); return; }

      setBusy(true); toast("Performing compliance check...");

      try {
        const issuedAt = new Date().toISOString();

        const resp = await fetch(`${API_BASE}/opcheck/dataverse`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            dob,
            entity_type,
            business_reference,
            reason_for_check,
            requestor: user.fullname
          })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const entityId = data?.entity_id || data?.entity_key || "";

        currentReport = { name, dob, entity_type, data, user, timestamp: new Date(issuedAt), business_reference, reason_for_check, entityId };

        if (FLOW_URL) {
          try {
            const auditPayload = {
              request: {
                name,
                dob,
                entity_type,
                requestor: user.fullname,
                timestamp: issuedAt,
                business_reference,
                reason_for_check,
              },
              result: data,
              client_extras: { data_sources: DATA_SOURCES_TEXT, entity_id: entityId }
            };
            fetch(FLOW_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(auditPayload) })
              .catch(e=>console.warn("[PA] audit failed", e));
          } catch (e) {
            console.warn("[PA] audit exception", e);
          }
        }

        renderReport();
        el.pdfBtn.disabled = false;
        toast("Compliance check completed.", false);
      } catch (e) {
        console.error(e);
        el.report.innerHTML = "";
        el.pdfBtn.disabled = true;
        currentReport = null;
        toast("Check failed. Verify network/API/CORS.", true);
      } finally {
        setBusy(false);
      }
    }

    function normalizeTopMatches(tm) {
      if (!Array.isArray(tm)) return [];
      if (tm.length === 0) return [];
      if (typeof tm[0] === "object" && !Array.isArray(tm[0])) {
        return tm.map(x => ({ name: String(x?.name ?? ""), score: Number(x?.score ?? 0) })).filter(x=>x.name);
      }
      return tm.map(x => ({ name: String(x?.[0] ?? ""), score: Number(x?.[1] ?? 0) })).filter(x=>x.name);
    }

    function getStatusBadge(data) {
      if (data["Is Sanctioned"]) return { class: "status-match", text: "Sanctions Match", icon: "!" };
      if (data["Is PEP"]) return { class: "status-review", text: "PEP Identified", icon: "i" };
      return { class: "status-clear", text: "Clear", icon: "OK" };
    }

    const PDF_UK_PATTERNS = ["uk", "hmt", "ofsi", "hm treasury", "uk fcdo", "uk financial sanctions"];

    function pdfIsUKSource(item) {
      const lower = String(item || "").toLowerCase();
      return PDF_UK_PATTERNS.some((p) => lower.includes(p));
    }

    function pdfParseSources(source) {
      const raw = String(source || "").trim();
      if (!raw) return { list: [], hasUK: false, otherCount: 0, summaryLines: ["—"] };
      const list = raw
        .split(/[;,\n]+/)
        .map((s) => s.trim())
        .filter(Boolean);
      const items = list.length > 0 ? list : [raw];
      const hasUK = items.some(pdfIsUKSource);
      const otherCount = items.filter((i) => !pdfIsUKSource(i)).length;
      const summaryLines = [];
      summaryLines.push(hasUK ? "UK sanctions: Yes" : "UK sanctions: No");
      if (otherCount > 0) summaryLines.push(`Other sanctions lists: ${otherCount}`);
      return { list: items, hasUK, otherCount, summaryLines };
    }

    function pdfSourceBadgeMeta(item) {
      const lower = String(item || "").toLowerCase();
      if (lower.includes("united nations") || lower === "un" || lower.includes(" un ")) {
        return { label: "UN", cls: "src-un", mark: "UN" };
      }
      if (lower.includes("eu") || lower.includes("european union") || lower.includes("eu council")) {
        return { label: "EU", cls: "src-eu", mark: "EU" };
      }
      if (lower.includes("ofac") || lower.includes("u.s.") || lower.includes("us treasury")) {
        return { label: "OFAC", cls: "src-ofac", mark: "US" };
      }
      if (lower.includes("hm treasury") || lower.includes("hmt") || lower.includes("ofsi") || lower.includes("uk")) {
        return { label: "HM Treasury", cls: "src-hmt", mark: "UK" };
      }
      return { label: item, cls: "src-other", mark: "•" };
    }

    function pdfExpandSourceBadgesForDisplay(sourceList) {
      const cleaned = (sourceList || []).map((s) => String(s || "").trim()).filter(Boolean);
      if (cleaned.length === 0) return [];
      const defaults = ["United Nations", "EU Council", "OFAC", "HM Treasury"];
      const isGeneric = (v) => v === "opensanctions" || v.includes("open sanctions") || v.includes("postgres watchlist");
      const normalized = cleaned.map((s) => s.toLowerCase());
      const hasGeneric = normalized.some(isGeneric);
      if (!hasGeneric) return cleaned;
      const withoutGeneric = cleaned.filter((s) => !isGeneric(s.toLowerCase()));
      const merged = [...defaults, ...withoutGeneric];
      return [...new Set(merged)];
    }

    function pdfFormatTopMatch(m) {
      if (Array.isArray(m) && m.length >= 2) return { name: String(m[0]), score: Number(m[1]) };
      if (m && typeof m === "object" && "name" in m) return { name: String(m.name), score: Number(m.score ?? 0) };
      return { name: String(m), score: 0 };
    }

    function pdfFormatEntityTypeLabel(entityType) {
      return entityType === "Organization" ? "Organisation" : entityType;
    }

    function pdfGuidanceText(result) {
      if (result["Is Sanctioned"]) return "Potential sanctions match. Stop and escalate for enhanced review before proceeding.";
      if (result["Is PEP"]) return "PEP indicator found. Continue with enhanced due diligence and record rationale.";
      return "No sanctions or PEP match found under current rules.";
    }

    function pdfStatusTone(result) {
      if (result["Is Sanctioned"]) return "#ef4444";
      if (result["Is PEP"]) return "#0284c7";
      return "#16a34a";
    }

    function pdfVerificationHash(input) {
      let hash = 2166136261;
      const text = String(input || "");
      for (let i = 0; i < text.length; i++) {
        hash ^= text.charCodeAt(i);
        hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
      }
      return (hash >>> 0).toString(16).padStart(8, "0").toUpperCase();
    }

    function pdfBuildSnapshotHtml(result, search) {
      const summary = result["Check Summary"] || {};
      const parsed = pdfParseSources(summary?.Source);
      const sourceList = parsed.list;
      const hasUK = parsed.hasUK;
      const otherCount = parsed.otherCount;
      const summaryLines = parsed.summaryLines;
      const topMatches = (result["Top Matches"] || []).map(pdfFormatTopMatch).slice(0, 5);
      const tone = pdfStatusTone(result);
      const checkedAt = summary?.Date || "—";
      const sourceSummary = `${hasUK ? "UK sanctions: Yes" : "UK sanctions: No"}${otherCount > 0 ? ` · Other lists: ${otherCount}` : ""}`;
      const matchedName = result["Sanctions Name"] || "—";
      const matchedDob = result["Birth Date"] || "—";
      const matchedRegime = result.Regime || "—";
      const backendLabel = search.searchBackend === "postgres_beta" ? "Postgres (Default)" : "Original (Parquet fallback)";
      const hasMatchedSubject = Boolean(result["Match Found"] && (result["Sanctions Name"] || result.Regime || result["Birth Date"]));
      const entityRef = result.entity_key || result.entity_id || "Not available";

      const docIdSeed = [
        entityRef || "",
        search.searchName || "",
        search.businessReference || "",
        search.requestor || "",
        checkedAt || "",
        String(result.Score ?? ""),
      ].join("|");
      const docId = `SCR-${pdfVerificationHash(docIdSeed)}-${pdfVerificationHash(`${docIdSeed}|A`)}`;
      const docFingerprint = pdfVerificationHash(`${docIdSeed}|FINGERPRINT|${summary?.Status || ""}|${result["Risk Level"] || ""}`);
      const generatedUtc = new Date().toISOString();

      const topMatchRows = topMatches.length
        ? topMatches
            .map((m) => `\n<tr><td>${escapeHtml(m.name)}</td><td class="score-col">${m.score}</td></tr>`)
            .join("")
        : '<tr><td colspan="2" class="muted">No similarity suggestions.</td></tr>';

      const sourceBadgeItems = pdfExpandSourceBadgesForDisplay(sourceList);
      const sourceBadges = sourceBadgeItems.length
        ? sourceBadgeItems
            .slice(0, 12)
            .map((s) => {
              const meta = pdfSourceBadgeMeta(s);
              return `<span class="src-badge ${meta.cls}" title="${escapeHtml(s)}"><span class="mark">${escapeHtml(meta.mark)}</span>${escapeHtml(meta.label)}</span>`;
            })
            .join("")
        : '<div class="muted">No source list details provided.</div>';

      return `
      <div class="page">
        <div class="watermark">SYSTEM GENERATED • AUDIT RECORD • SYSTEM GENERATED • AUDIT RECORD</div>

        <header class="header">
          <div>
            <p class="eyebrow">Compliance Screening Record</p>
            <h1>Sanctions &amp; PEP Screening Report</h1>
          </div>
          <div class="doc-id">Document ID: ${escapeHtml(docId)}</div>
        </header>

        <section class="summary-band">
          <div class="summary-cell status" style="--tone:${tone}">
            <span class="label">Status</span>
            <strong>${escapeHtml(summary?.Status || "Unknown")}</strong>
            <div class="outcome">${escapeHtml(pdfGuidanceText(result))}</div>
          </div>
          <div class="summary-cell">
            <span class="label">Risk Level</span>
            <strong>${escapeHtml(result["Risk Level"] || "—")}</strong>
          </div>
          <div class="summary-cell">
            <span class="label">Confidence</span>
            <strong>${escapeHtml(result.Confidence || "—")}</strong>
          </div>
          <div class="summary-cell">
            <span class="label">Score</span>
            <strong>${escapeHtml(String(result.Score ?? "—"))}</strong>
          </div>
        </section>

        <main class="content">
          <section class="panel">
            <h2>Screening Request</h2>
            <table class="kv-table">
              <tr><th>Name / Organisation</th><td>${escapeHtml(search.searchName || "—")}</td></tr>
              <tr><th>Entity Type</th><td>${escapeHtml(pdfFormatEntityTypeLabel(search.entityType || "—"))}</td></tr>
              <tr><th>Date of Birth Input</th><td>${escapeHtml(search.searchDob?.trim() ? search.searchDob : "Not provided")}</td></tr>
              <tr><th>Requested By</th><td>${escapeHtml(search.requestor || "—")}</td></tr>
              <tr><th>Business Reference</th><td>${escapeHtml(search.businessReference || "—")}</td></tr>
              <tr><th>Reason for Check</th><td>${escapeHtml(search.reasonForCheck || "—")}</td></tr>
            </table>
          </section>

          <section class="panel">
            <h2>Decision &amp; Actions</h2>
            <table class="kv-table">
              <tr><th>Checked At</th><td>${escapeHtml(checkedAt)}</td></tr>
              <tr><th>Sanctions Match</th><td>${result["Is Sanctioned"] ? "Yes" : "No"}</td></tr>
              <tr><th>PEP Indicator</th><td>${result["Is PEP"] ? "Yes" : "No"}</td></tr>
              <tr><th>Source Summary</th><td>${escapeHtml(sourceSummary || "—")}</td></tr>
            </table>
          </section>

          <section class="panel">
            <h2>Matched Subject</h2>
            ${
              hasMatchedSubject
                ? `<table class="kv-table">
              <tr><th>Name</th><td>${escapeHtml(matchedName)}</td></tr>
              <tr><th>Date of Birth</th><td>${escapeHtml(matchedDob)}</td></tr>
              <tr><th>Regime</th><td>${escapeHtml(matchedRegime)}</td></tr>
            </table>`
                : '<div class="muted compact">No matched subject identified for this check.</div>'
            }
          </section>

          <section class="panel">
            <h2>Sources Reviewed</h2>
            <div class="source-badges">${sourceBadges}</div>
          </section>

          <section class="panel span2">
            <h2>Name Similarity Suggestions</h2>
            <table class="data-table">
              <thead><tr><th>Candidate Name</th><th class="score-col">Score</th></tr></thead>
              <tbody>${topMatchRows}</tbody>
            </table>
          </section>

          <section class="panel span2">
            <h2>Audit Metadata</h2>
            <table class="kv-table audit">
              <tr><th>Document ID</th><td>${escapeHtml(docId)}</td></tr>
              <tr><th>Verification Fingerprint</th><td>${escapeHtml(docFingerprint)}</td></tr>
              <tr><th>Entity Key Reference</th><td>${escapeHtml(entityRef)}</td></tr>
              <tr><th>Search Backend</th><td>${escapeHtml(backendLabel)}</td></tr>
              <tr><th>Generated (UTC)</th><td>${escapeHtml(generatedUtc)}</td></tr>
              <tr><th>Coverage Notes</th><td>${escapeHtml(summaryLines.join(" · "))}</td></tr>
            </table>
          </section>
        </main>

        <div class="footer-note">System-generated report. Validate using Document ID and Entity Key reference.</div>
      </div>
      <style>
        * { box-sizing: border-box; font-family: MediumLL, Inter, system-ui, sans-serif; }
        .page {
          width: 1400px;
          min-height: 860px;
          padding: 18px;
          color: #0f172a;
          background:
            repeating-linear-gradient(135deg, rgba(2,132,199,.02), rgba(2,132,199,.02) 8px, rgba(14,165,233,.02) 8px, rgba(14,165,233,.02) 16px),
            #eef3f7;
          position: relative;
          overflow: hidden;
        }
        .watermark {
          position: absolute;
          top: 46%;
          left: -180px;
          transform: rotate(-24deg);
          font-size: 28px;
          letter-spacing: .08em;
          font-weight: 700;
          color: rgba(2,132,199,.07);
          white-space: nowrap;
          pointer-events: none;
          user-select: none;
        }
        .header {
          display: flex;
          align-items: flex-start;
          justify-content: space-between;
          gap: 12px;
          padding: 12px 14px;
          border-radius: 12px;
          border: 1px solid rgba(148,163,184,.34);
          background: #fff;
          position: relative;
          z-index: 2;
        }
        .eyebrow { margin: 0; font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color: #475569; font-weight: 700; }
        h1 { margin: 2px 0 0 0; font-size: 24px; line-height: 1.2; }
        .doc-id {
          font-size: 11px;
          font-weight: 700;
          letter-spacing: .06em;
          text-transform: uppercase;
          border: 1px solid rgba(148,163,184,.34);
          background: #f8fafc;
          border-radius: 999px;
          padding: 7px 10px;
          white-space: nowrap;
        }
        .summary-band {
          margin-top: 10px;
          display: grid;
          grid-template-columns: 2fr 1fr 1fr 1fr;
          gap: 8px;
          position: relative;
          z-index: 2;
        }
        .summary-cell {
          border: 1px solid rgba(148,163,184,.32);
          background: #fff;
          border-radius: 10px;
          padding: 8px 10px;
        }
        .summary-cell.status { border-left: 4px solid var(--tone); }
        .summary-cell .label {
          display: block;
          font-size: 11px;
          letter-spacing: .08em;
          text-transform: uppercase;
          color: #64748b;
          margin-bottom: 2px;
          font-weight: 700;
        }
        .summary-cell strong { font-size: 18px; line-height: 1.2; }
        .summary-cell.status strong { font-size: 28px; line-height: 1.05; display: block; }
        .outcome {
          margin-top: 6px;
          font-size: 11px;
          line-height: 1.35;
          color: #334155;
          font-weight: 600;
        }
        .content {
          margin-top: 10px;
          display: grid;
          grid-template-columns: 1.25fr 1fr;
          gap: 8px;
          position: relative;
          z-index: 2;
        }
        .panel {
          border: 1px solid rgba(148,163,184,.3);
          border-radius: 10px;
          background: #fff;
          padding: 10px;
        }
        .panel.span2 { grid-column: span 2; }
        h2 {
          margin: 0 0 8px 0;
          font-size: 12px;
          letter-spacing: .1em;
          text-transform: uppercase;
          color: #475569;
          font-weight: 700;
        }
        .kv-table, .data-table {
          width: 100%;
          border-collapse: collapse;
          table-layout: fixed;
          font-size: 12px;
        }
        .kv-table th, .kv-table td {
          padding: 6px 6px;
          border-bottom: 1px solid rgba(148,163,184,.24);
          vertical-align: top;
        }
        .kv-table th {
          width: 34%;
          text-align: left;
          color: #475569;
          font-weight: 700;
        }
        .kv-table td { color: #0f172a; font-weight: 600; word-break: break-word; }
        .kv-table tr:last-child th, .kv-table tr:last-child td { border-bottom: 0; }
        .data-table th, .data-table td {
          padding: 6px;
          border-bottom: 1px solid rgba(148,163,184,.24);
          text-align: left;
          vertical-align: top;
        }
        .data-table thead th {
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: .08em;
          color: #475569;
          font-weight: 700;
          background: #f8fafc;
        }
        .data-table tbody td { font-size: 12px; color: #0f172a; }
        .data-table tr:last-child td { border-bottom: 0; }
        .score-col { width: 70px; text-align: right; font-weight: 700; }
        .source-badges { display: flex; flex-wrap: wrap; gap: 8px; }
        .src-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,184,.34);
          background: #f8fafc;
          color: #0f172a;
          font-size: 11px;
          font-weight: 700;
          letter-spacing: .04em;
          padding: 5px 10px;
          text-transform: uppercase;
        }
        .src-badge .mark {
          width: 18px;
          height: 18px;
          border-radius: 999px;
          display: inline-grid;
          place-items: center;
          text-align: center;
          font-size: 8px;
          font-weight: 800;
          line-height: 18px;
          letter-spacing: .03em;
          border: 1px solid rgba(148,163,184,.45);
          background: #e2e8f0;
          color: #0f172a;
          padding: 0;
          vertical-align: middle;
        }
        .src-badge.src-un .mark { background: #d8f5fb; border-color: #67e8f9; color: #0c4a6e; }
        .src-badge.src-eu .mark { background: #dbeafe; border-color: #93c5fd; color: #1e3a8a; }
        .src-badge.src-ofac .mark { background: #fee2e2; border-color: #fca5a5; color: #7f1d1d; }
        .src-badge.src-hmt .mark { background: #dbeafe; border-color: #93c5fd; color: #1e3a8a; }
        .src-badge.src-other .mark { background: #e2e8f0; border-color: #cbd5e1; color: #475569; }
        .muted { color: #64748b; font-style: italic; }
        .muted.compact { padding: 4px 2px; font-size: 12px; }
        .audit td { font-family: DmMono, ui-monospace, monospace; font-size: 11px; font-weight: 600; }
        .footer-note {
          margin-top: 8px;
          font-size: 9px;
          color: #64748b;
          letter-spacing: .04em;
          text-transform: uppercase;
          text-align: right;
          position: relative;
          z-index: 2;
        }
      </style>`;
    }

    function renderReport() {
      if (!currentReport) return;
      const { name, dob, entity_type, data, user, timestamp, business_reference, reason_for_check, entityId } = currentReport;
      const s = data?.["Check Summary"] || {};
      const generated = timestamp.toLocaleString();
      const statusBadge = getStatusBadge(data);
      const topMatches = normalizeTopMatches(data?.["Top Matches"] || []);

      const topMatchesHTML = topMatches.length
        ? `<div class="section">
            <h3>Potential Matches</h3>
            <div class="match-list">
              ${topMatches.slice(0,5).map((m,i)=>`
                <div class="match-item">
                  <div class="match-score">${Number.isFinite(m.score) ? m.score.toFixed(0) + '%' : 'N/A'}</div>
                  <strong>Match ${i+1}:</strong> ${escapeHtml(m.name)}
                  <div style="font-size:12px;color:#666;margin-top:4px;">Similarity score for user review</div>
                </div>
              `).join("")}
            </div>
          </div>`
        : `<div class="section"><h3>No Significant Name Matches</h3><p style="color:#666;margin:0;">No entries above the similarity threshold.</p></div>`;

      const sourcesRow = `
        <div class="sources-row">
          <span class="source-chip">${ICONS.UN} UN</span>
          <span class="source-chip">${ICONS.EU} EU</span>
          <span class="source-chip">${ICONS.US} OFAC</span>
          <span class="source-chip">${ICONS.UK} HM Treasury</span>
        </div>
      `;

      el.report.innerHTML = `
        <div id="reportRoot" style="position:relative;">
          <div class="watermark">CONFIDENTIAL</div>

          <div class="report-header">
            <div class="report-title">
              <h2>Sanctions & PEP Screening Report</h2>
              <div class="report-ref">REF: ${escapeHtml(business_reference)}</div>
            </div>
            <div class="report-meta">
              <div><div class="meta-label">Generated</div><div class="meta-value">${generated}</div></div>
              <div><div class="meta-label">Performed by</div><div class="meta-value">${escapeHtml(user.fullname)}</div></div>
              <div><div class="meta-label">Source</div><div class="meta-value">${escapeHtml(s.Source || "United Nations; European Union; US OFAC; UK HM Treasury (OFSI)")}</div></div>
              <div><div class="meta-label">Status</div><div class="meta-value"><span class="status-badge ${statusBadge.class}">${statusBadge.icon} ${statusBadge.text}</span></div></div>
            </div>
          </div>

          <div class="report-body">
            <div class="section">
              <h3>Search Criteria</h3>
              <table class="kv-table">
                <tr><td class="key">Subject Name</td><td><strong>${escapeHtml(name)}</strong></td></tr>
                <tr><td class="key">Date of Birth</td><td>${dob || "Not provided"}</td></tr>
                <tr><td class="key">Entity Type</td><td>${escapeHtml(entity_type)}</td></tr>
                <tr><td class="key">Performed by</td><td>${escapeHtml(user.fullname)}</td></tr>
                <tr><td class="key">Business Reference</td><td><code class="mono">${escapeHtml(business_reference)}</code></td></tr>
                <tr><td class="key">Reason for check</td><td>${escapeHtml(reason_for_check)}</td></tr>
              </table>
            </div>

            <div class="section">
              <h3>Compliance Summary</h3>
              <table class="kv-table">
                <tr><td class="key">Overall Status</td><td><span class="status-badge ${statusBadge.class}">${statusBadge.icon} ${statusBadge.text}</span></td></tr>
                <tr><td class="key">Risk Assessment</td><td><strong>${escapeHtml(data["Risk Level"] || "Low")}</strong></td></tr>
                <tr><td class="key">Confidence Level</td><td>${escapeHtml(data.Confidence || "Very High")}</td></tr>
                <tr><td class="key">Match Score</td><td>${data.Score ?? "0"}</td></tr>
                <tr><td class="key">Sanctions Listed</td><td><strong>${data["Is Sanctioned"] ? "YES" : "NO"}</strong></td></tr>
                <tr><td class="key">PEP Status</td><td><strong>${data["Is PEP"] ? "YES" : "NO"}</strong></td></tr>
              </table>
            </div>

            ${(data["Is Sanctioned"] || data["Is PEP"]) ? `
              <div class="section">
                <h3>Match Details</h3>
                <table class="kv-table">
                  <tr><td class="key">Matched Name</td><td><strong>${escapeHtml(data["Sanctions Name"] || "N/A")}</strong></td></tr>
                  <tr><td class="key">Birth Date</td><td>${escapeHtml(data["Birth Date"] || "Not available")}</td></tr>
                  <tr><td class="key">Sanctions Regime</td><td>${escapeHtml(data["Regime"] || "Not specified")}</td></tr>
                </table>
              </div>
            ` : ""}

            ${topMatchesHTML}

            <div class="section">
              <h3>Data Sources Queried</h3>
              ${sourcesRow}
              <div style="margin-top:8px;font-size:12px;color:#666;"><strong>Sources:</strong> ${escapeHtml(DATA_SOURCES_TEXT)}</div>
            </div>

            <div class="section">
              <h3>Audit Entity Record</h3>
              <table class="kv-table">
                <tr><td class="key">Entity ID</td><td><code class="mono">${escapeHtml(entityId || "Not returned")}</code></td></tr>
                <tr><td class="key">Business Reference</td><td><code class="mono">${escapeHtml(business_reference)}</code></td></tr>
                <tr><td class="key">Reason for check</td><td>${escapeHtml(reason_for_check)}</td></tr>
                <tr><td class="key">Issued At (UTC)</td><td><code class="mono">${timestamp.toISOString()}</code></td></tr>
              </table>
              <div style="font-size:12px;color:#666;margin-top:6px;">Use Entity ID as the auditable record key to cross-check against the screened entity database.</div>
            </div>

            <div class="section">
              <div style="font-size:11px;color:#777;">
                Report generated by sanctions-check.co.uk client on ${generated}. This is not a legal record of identity. User review is required for any match.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function downloadPDF() {
      if (!currentReport?.data) { toast("Nothing to export yet.", true); return; }

      try {
        const { jsPDF } = window.jspdf;
        const result = { ...currentReport.data };
        const entityId = currentReport.entityId || result.entity_id || result.entity_key || "";
        if (!result.entity_key && entityId) result.entity_key = entityId;
        const search = {
          searchName: currentReport.name || "",
          entityType: currentReport.entity_type || "Person",
          searchDob: currentReport.dob || "",
          requestor: currentReport.user?.fullname || "Unknown",
          businessReference: currentReport.business_reference || "",
          reasonForCheck: currentReport.reason_for_check || "",
          searchBackend: "postgres_beta",
        };

        const wrapper = document.createElement("div");
        wrapper.style.position = "fixed";
        wrapper.style.left = "-10000px";
        wrapper.style.top = "0";
        wrapper.style.width = "1400px";
        wrapper.style.zIndex = "-1";
        wrapper.innerHTML = pdfBuildSnapshotHtml(result, search);
        document.body.appendChild(wrapper);

        try {
          const canvas = await html2canvas(wrapper.firstElementChild, {
            backgroundColor: "#eef3f7",
            scale: 2,
            useCORS: true,
            logging: false,
          });

          const imgData = canvas.toDataURL("image/png");
          const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4", compress: true });

          const pageW = doc.internal.pageSize.getWidth();
          const pageH = doc.internal.pageSize.getHeight();
          const margin = 8;
          const footerBand = 14;
          const maxW = pageW - margin * 2;
          const maxH = pageH - margin * 2 - footerBand;

          const imgW = canvas.width;
          const imgH = canvas.height;
          const ratio = Math.min(maxW / imgW, maxH / imgH);
          const renderW = imgW * ratio;
          const renderH = imgH * ratio;
          const x = (pageW - renderW) / 2;
          const y = margin;

          doc.addImage(imgData, "PNG", x, y, renderW, renderH, undefined, "FAST");

          const keyText = result.entity_key?.trim() ? `Entity key: ${result.entity_key}` : "Entity key: not available";
          const checkedAt = result["Check Summary"]?.Date || "—";
          doc.setFont("helvetica", "normal");
          doc.setFontSize(9);
          doc.setTextColor(60, 60, 60);
          doc.text(`Checked at: ${checkedAt}`, margin, pageH - 8);
          doc.text(keyText, pageW / 2, pageH - 8, { align: "center" });
          doc.text(`Generated: ${new Date().toISOString()}`, pageW - margin, pageH - 8, { align: "right" });
          doc.setTextColor(0, 0, 0);

          const safeName = search.searchName.replace(/[^a-zA-Z0-9\s-]/g, "").slice(0, 40) || "screening";
          const filename = `screening-result-${safeName.replace(/\s+/g, "-")}-${Date.now()}.pdf`;
          doc.save(filename);
        } finally {
          document.body.removeChild(wrapper);
        }
      } catch (e) {
        console.error(e);
        toast("PDF generation failed.", true);
      }
    }

    function toast(msg, isErr=false) {
      el.status.textContent = msg;
      el.status.classList.toggle("error", !!isErr);
      el.status.classList.toggle("success", !isErr);
    }

    function setBusy(b) {
      el.runBtn.disabled = b;
      el.pdfBtn.disabled = b || el.pdfBtn.disabled;
      el.clearBtn.disabled = b;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");
    }

  </script>
</body>
</html>
