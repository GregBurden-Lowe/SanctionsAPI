<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sanctions & PEP Compliance Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>

  <style>
:root {
  --bg: #eef3f7;
  --surface: #ffffff;
  --surface-soft: #f8fbfe;
  --surface-strong: #f1f6fb;
  --text: #0f172a;
  --muted: #475569;
  --muted-soft: #64748b;
  --primary: #0ea5e9;
  --primary-strong: #0284c7;
  --primary-soft: #e0f2fe;
  --success: #15803d;
  --warning: #b45309;
  --danger: #b91c1c;
  --border: rgba(148, 163, 184, 0.35);
  --ring: rgba(14, 165, 233, 0.25);
  --shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
  --radius-card: 18px;
  --radius-md: 12px;
  --radius-sm: 10px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font: 14px/1.5 Inter, "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
  color: var(--text);
  background: radial-gradient(circle at 0% 0%, rgba(14, 165, 233, 0.14), transparent 42%), var(--bg);
}

.wrap {
  max-width: 1080px;
  margin: 24px auto;
  padding: 0 16px;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-card);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.card .hd {
  padding: 18px 24px;
  background: linear-gradient(135deg, #0f172a 0%, #0b2840 60%, #0f3a58 100%);
  color: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.16);
}

.card .bd { padding: 24px; }

.logo-section { display: flex; align-items: center; gap: 14px; }

.logo-placeholder {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  font-weight: 800;
  letter-spacing: .02em;
  color: #0f172a;
  background: linear-gradient(140deg, #bae6fd 0%, #e0f2fe 100%);
  border: 1px solid rgba(255, 255, 255, 0.6);
}

.header-text h1 {
  font-size: 20px;
  margin: 0;
  font-weight: 700;
  letter-spacing: .01em;
}

.subtitle {
  margin-top: 2px;
  font-size: 12px;
  color: rgba(248, 250, 252, 0.78);
  text-transform: uppercase;
  letter-spacing: .08em;
  font-weight: 600;
}

.security-badge {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: #e2e8f0;
  border: 1px solid rgba(226, 232, 240, 0.35);
  background: rgba(15, 23, 42, 0.45);
  border-radius: 999px;
  padding: 7px 12px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 12px;
}

.col-2 { grid-column: span 2; }
.col-4 { grid-column: span 4; }

.form-group { margin-bottom: 0; }

label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  margin: 0 0 6px;
  text-transform: uppercase;
  letter-spacing: .06em;
}

input,
select {
  width: 100%;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 12px;
  outline: none;
  font-size: 14px;
  color: var(--text);
  background: var(--surface);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}

input::placeholder { color: var(--muted-soft); }

input:focus,
select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--ring);
}

.btns {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 4px;
}

button {
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 16px;
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  transition: all .15s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

button.primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
  border-color: transparent;
  color: #fff;
}

button.primary:hover {
  filter: brightness(.98);
  transform: translateY(-1px);
}

button:hover {
  background: var(--surface-soft);
  transform: translateY(-1px);
}

button:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px var(--ring);
}

button:disabled {
  opacity: .58;
  cursor: not-allowed;
  transform: none;
}

.status {
  margin-top: 8px;
  color: var(--muted);
  font-size: 13px;
  font-weight: 600;
}

.error { color: var(--danger); }
.success { color: var(--success); }

.user-info {
  background: linear-gradient(135deg, #eff6ff 0%, #e0f2fe 100%);
  border: 1px solid #bfdbfe;
  border-radius: var(--radius-md);
  padding: 14px;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 800;
  color: #fff;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-strong) 100%);
}

.report { margin-top: 22px; }

.report-header {
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 12px 12px 0 0;
  background: linear-gradient(135deg, #f8fbff 0%, #eef5fb 100%);
  padding: 18px 22px;
  position: relative;
}

.report-body {
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 12px 12px;
  background: var(--surface);
}

.report-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.report-title h2 {
  font-size: 19px;
  margin: 0;
  font-weight: 700;
}

.report-ref {
  background: #0f172a;
  color: #f8fafc;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 11px;
  font-weight: 700;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}

.report-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 12px;
  margin-top: 8px;
}

.meta-label {
  color: var(--muted-soft);
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .07em;
}

.meta-value {
  color: var(--text);
  font-weight: 700;
  font-size: 13px;
}

.section {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
}

.section:last-child { border-bottom: none; }

.section h3 {
  font-size: 15px;
  margin: 0 0 12px;
  font-weight: 700;
  color: #0f172a;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  padding: 5px 10px;
}

.status-clear { background: #dcfce7; color: #14532d; }
.status-match { background: #fee2e2; color: #7f1d1d; }
.status-review { background: #fef3c7; color: #78350f; }

.kv-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.kv-table th,
.kv-table td {
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.kv-table th {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .06em;
  background: var(--surface-strong);
}

.kv-table td {
  font-size: 13px;
}

.kv-table td.key {
  width: 220px;
  color: var(--muted);
  font-weight: 700;
  background: #fbfdff;
}

.kv-table tr:last-child th,
.kv-table tr:last-child td {
  border-bottom: none;
}

.match-list {
  margin-top: 8px;
  display: grid;
  gap: 10px;
}

.match-item {
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #f8fbff;
  padding: 12px;
}

.match-score {
  float: right;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 11px;
  font-weight: 800;
  color: #7c2d12;
  background: #fed7aa;
}

.watermark {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-34deg);
  font-size: 72px;
  font-weight: 900;
  letter-spacing: .04em;
  color: rgba(2, 132, 199, 0.06);
  pointer-events: none;
  user-select: none;
}

.sources-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.source-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 5px 10px;
  background: #fff;
  color: #1e293b;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .03em;
}

.source-chip svg {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  flex: 0 0 auto;
}

.mono {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}

@media (max-width: 980px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .col-2,
  .col-4 {
    grid-column: span 2;
  }

  .report-title {
    align-items: flex-start;
    flex-direction: column;
  }
}

@media (max-width: 700px) {
  .card .hd {
    align-items: flex-start;
    flex-direction: column;
    gap: 10px;
  }

  .grid,
  .report-meta {
    grid-template-columns: 1fr;
  }

  .col-2,
  .col-4 {
    grid-column: span 1;
  }

  .btns {
    display: grid;
    grid-template-columns: 1fr;
  }

  .kv-table td.key {
    width: 140px;
  }
}

@media print {
  .no-print { display: none !important; }

  body {
    margin: 0;
    background: #fff;
  }

  .card {
    border: none;
    box-shadow: none;
  }

  .watermark {
    color: rgba(2, 132, 199, 0.04);
  }
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="logo-section">
          <div class="logo-placeholder">SC</div>
          <div class="header-text">
            <h1>Sanctions & PEP Compliance Check</h1>
            <div class="subtitle">Screening Service</div>
          </div>
        </div>
        <div class="security-badge">Secure Session</div>
      </div>

      <div class="bd">
        <div class="user-info no-print" id="userInfo">
          <div class="user-avatar" id="userAvatar">?</div>
          <div>
            <strong>Authorized User:</strong> <span id="currentUserDisplay">Loading...</span><br>
            <small class="muted">Session Active</small>
          </div>
        </div>

        <div class="grid">
          <div class="col-2 form-group">
            <label for="name">Full name / Organisation *</label>
            <input id="name" placeholder="Enter individual or entity name" />
          </div>
          <div class="form-group">
            <label for="dob">Date of birth (optional)</label>
            <input id="dob" type="date" />
          </div>
          <div class="form-group">
            <label for="etype">Entity type</label>
            <select id="etype">
              <option value="Person">Individual Person</option>
              <option value="Organization">Organization/Entity</option>
            </select>
          </div>
          <div class="col-4 btns no-print">
            <button class="primary" id="runBtn">Run Compliance Check</button>
            <button id="pdfBtn" disabled>Download Report</button>
            <button id="clearBtn">Clear Form</button>
          </div>
        </div>

        <div class="status" id="status"></div>

        <div class="report" id="report" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://sanctions-check.co.uk";
    const FLOW_URL = "";
    const DATA_SOURCES_TEXT = "United Nations; European Union; US OFAC; UK HM Treasury (OFSI)";

    const ICONS = {
      UN: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="#009edb"/><circle cx="32" cy="32" r="14" fill="#fff"/><circle cx="32" cy="32" r="9" fill="#009edb"/></svg>`,
      EU: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#003399"/><g fill="#ffcc00">` +
          Array.from({length:12}).map((_,i)=> {
            const a = (i*30-90)*Math.PI/180, R=14, cx=32+R*Math.cos(a), cy=21+R*Math.sin(a);
            return `<polygon transform="translate(${cx},${cy})" points="0,-3 0.9,-0.9 3,0 0.9,0.9 0,3 -0.9,0.9 -3,0 -0.9,-0.9"/>`
          }).join("") + `</g></svg>`,
      US: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#b22234"/>` +
          Array.from({length:7}).map((_,i)=>`<rect y="${i*6}" width="64" height="3" fill="#fff"/>`).join("") +
          `<rect width="26" height="19" fill="#3c3b6e"/></svg>`,
      UK: `<svg viewBox="0 0 64 42" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="42" fill="#012169"/><path d="M0,0 64,42 M64,0 0,42" stroke="#fff" stroke-width="8"/><path d="M0,0 64,42 M64,0 0,42" stroke="#C8102E" stroke-width="4"/><path d="M32,0 v42 M0,21 h64" stroke="#fff" stroke-width="12"/><path d="M32,0 v42 M0,21 h64" stroke="#C8102E" stroke-width="8"/></svg>`
    };

    let currentUser = null;
    let currentReport = null;

    const el = {
      name: document.getElementById("name"),
      dob: document.getElementById("dob"),
      etype: document.getElementById("etype"),
      runBtn: document.getElementById("runBtn"),
      pdfBtn: document.getElementById("pdfBtn"),
      clearBtn: document.getElementById("clearBtn"),
      status: document.getElementById("status"),
      report: document.getElementById("report"),
      currentUserDisplay: document.getElementById("currentUserDisplay"),
      userAvatar: document.getElementById("userAvatar"),
    };

    getCurrentUser();
    el.runBtn.addEventListener("click", runCheck);
    el.pdfBtn.addEventListener("click", downloadPDF);
    el.clearBtn.addEventListener("click", clearForm);

    function clearForm() {
      el.name.value = "";
      el.dob.value = "";
      el.etype.value = "Person";
      el.report.innerHTML = "";
      el.status.textContent = "";
      el.pdfBtn.disabled = true;
      currentReport = null;
    }

    function getXrm() {
      if (typeof Xrm !== "undefined" && Xrm.Utility) return Xrm;
      if (window.parent && window.parent.Xrm && window.parent.Xrm.Utility) return window.parent.Xrm;
      if (window.top && window.top.Xrm && window.top.Xrm.Utility) return window.top.Xrm;
      return null;
    }

    function waitForXrm(maxMs = 3000, step = 100) {
      return new Promise((resolve) => {
        const start = Date.now();
        (function poll() {
          const x = getXrm();
          if (x) return resolve(x);
          if (Date.now() - start >= maxMs) return resolve(null);
          setTimeout(poll, step);
        })();
      });
    }

    async function getCurrentUser() {
      try {
        const x = await waitForXrm();

        if (x && x.Utility && x.Utility.getGlobalContext) {
          const gc = x.Utility.getGlobalContext();
          const us = gc.userSettings || {};
          const clientUrl = (gc.getClientUrl && gc.getClientUrl()) || "";
          const rawId = (us.userId || "").replace(/[{}]/g, "");
          const fallbackName = us.userName || "Dataverse User";

          if (rawId && x.WebApi && x.WebApi.retrieveRecord) {
            try {
              const rec = await x.WebApi.retrieveRecord(
                "systemuser",
                rawId,
                "?$select=fullname,domainname,internalemailaddress,systemuserid"
              );
              currentUser = {
                fullname: rec.fullname || fallbackName,
                domainname: rec.domainname || "",
                email: rec.internalemailaddress || "",
                userid: rec.systemuserid || rawId,
                method: "Xrm.WebApi",
                clientUrl
              };
              updateUserDisplay();
              return currentUser;
            } catch (e) {
              console.warn("[user] Xrm.WebApi.retrieveRecord failed, fallback:", e);
            }
          }

          currentUser = {
            fullname: fallbackName,
            domainname: us.domainName || "",
            email: "",
            userid: rawId || (us.userId || ""),
            method: "Xrm.UserSettings",
            clientUrl
          };
          updateUserDisplay();
          return currentUser;
        }

        let orgUrl = "";
        try {
          const href = window.location.href;
          const m = href.match(/https:\/\/([^\/]+\.dynamics\.com)/) ||
                    href.match(/https:\/\/([^\/]+\.crm\d*\.dynamics\.com)/) ||
                    href.match(/https:\/\/([^\/]+)/);
          if (m) orgUrl = "https://" + m[1];
        } catch {}

        if (orgUrl) {
          const odataHeaders = {
            "Accept": "application/json",
            "Content-Type": "application/json; charset=utf-8",
            "OData-Version": "4.0",
            "OData-MaxVersion": "4.0"
          };

          const who = await fetch(`${orgUrl}/api/data/v9.2/WhoAmI`, {
            method: "GET",
            credentials: "include",
            headers: odataHeaders
          });

          if (who.ok) {
            const whoJson = await who.json();
            const userId = whoJson.UserId;
            const u = await fetch(`${orgUrl}/api/data/v9.2/systemusers(${userId})?$select=fullname,domainname,internalemailaddress,systemuserid`, {
              method: "GET",
              credentials: "include",
              headers: odataHeaders
            });
            if (u.ok) {
              const uj = await u.json();
              currentUser = {
                fullname: uj.fullname || "Dataverse User",
                domainname: uj.domainname || "",
                email: uj.internalemailaddress || "",
                userid: uj.systemuserid || userId,
                method: "REST",
                clientUrl: orgUrl
              };
              updateUserDisplay();
              return currentUser;
            }
          }
        }

        currentUser = {
          fullname: "Compliance Officer",
          domainname: "",
          email: "",
          userid: "system-user",
          method: "Fallback",
          clientUrl: ""
        };
        updateUserDisplay();
        return currentUser;
      } catch (err) {
        console.error("[user] unexpected error:", err);
        currentUser = {
          fullname: "System User",
          domainname: "",
          email: "",
          userid: "fallback-user",
          method: "Error-Fallback",
          clientUrl: ""
        };
        updateUserDisplay();
        return currentUser;
      }
    }

    function updateUserDisplay() {
      const name = currentUser?.fullname || "User";
      const dom = currentUser?.domainname ? ` (${currentUser.domainname})` : "";
      const avatar = name.charAt(0).toUpperCase();
      const elName = document.getElementById("currentUserDisplay");
      const elAvatar = document.getElementById("userAvatar");
      if (elName) elName.textContent = name + dom;
      if (elAvatar) elAvatar.textContent = avatar;
    }

    function getCurrentUserInfo() { return currentUser; }

    function generateReference() {
      const base = Math.floor(Date.now()/1000).toString(36).toUpperCase() + Math.random().toString(36).slice(2,6).toUpperCase();
      const hostCk = simpleHash(window.location.host).toString(36).toUpperCase().slice(0,2);
      return `${base}${hostCk}`;
    }

    function simpleHash(str) {
      let h = 0;
      for (let i=0;i<str.length;i++) { h = (h<<5) - h + str.charCodeAt(i); h |= 0; }
      return h >>> 0;
    }

    async function runCheck() {
      const name = el.name.value.trim();
      const dob = el.dob.value ? el.dob.value : null;
      const entity_type = el.etype.value;
      const user = getCurrentUserInfo();

      if (!name) { toast("Please enter a name to search.", true); return; }
      if (!user || !user.fullname) { toast("Unable to detect current user.", true); return; }

      setBusy(true); toast("Performing compliance check...");

      try {
        const issuedAt = new Date().toISOString();
        const ref = generateReference();

        const resp = await fetch(`${API_BASE}/opcheck/dataverse`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, dob, entity_type, requestor: user.fullname })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const entityId = data?.entity_id || data?.entity_key || "";

        currentReport = { name, dob, entity_type, data, user, timestamp: new Date(issuedAt), ref, entityId };

        if (FLOW_URL) {
          try {
            const auditPayload = {
              request: { name, dob, entity_type, requestor: user.fullname, timestamp: issuedAt, search_ref: ref },
              result: data,
              client_extras: { data_sources: DATA_SOURCES_TEXT, entity_id: entityId }
            };
            fetch(FLOW_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(auditPayload) })
              .catch(e=>console.warn("[PA] audit failed", e));
          } catch (e) {
            console.warn("[PA] audit exception", e);
          }
        }

        renderReport();
        el.pdfBtn.disabled = false;
        toast("Compliance check completed.", false);
      } catch (e) {
        console.error(e);
        el.report.innerHTML = "";
        el.pdfBtn.disabled = true;
        currentReport = null;
        toast("Check failed. Verify network/API/CORS.", true);
      } finally {
        setBusy(false);
      }
    }

    function normalizeTopMatches(tm) {
      if (!Array.isArray(tm)) return [];
      if (tm.length === 0) return [];
      if (typeof tm[0] === "object" && !Array.isArray(tm[0])) {
        return tm.map(x => ({ name: String(x?.name ?? ""), score: Number(x?.score ?? 0) })).filter(x=>x.name);
      }
      return tm.map(x => ({ name: String(x?.[0] ?? ""), score: Number(x?.[1] ?? 0) })).filter(x=>x.name);
    }

    function getStatusBadge(data) {
      if (data["Is Sanctioned"]) return { class: "status-match", text: "Sanctions Match", icon: "!" };
      if (data["Is PEP"]) return { class: "status-review", text: "PEP Identified", icon: "i" };
      return { class: "status-clear", text: "Clear", icon: "OK" };
    }

    function renderReport() {
      if (!currentReport) return;
      const { name, dob, entity_type, data, user, timestamp, ref, entityId } = currentReport;
      const s = data?.["Check Summary"] || {};
      const generated = timestamp.toLocaleString();
      const statusBadge = getStatusBadge(data);
      const topMatches = normalizeTopMatches(data?.["Top Matches"] || []);

      const topMatchesHTML = topMatches.length
        ? `<div class="section">
            <h3>Potential Matches</h3>
            <div class="match-list">
              ${topMatches.slice(0,5).map((m,i)=>`
                <div class="match-item">
                  <div class="match-score">${Number.isFinite(m.score) ? m.score.toFixed(0) + '%' : 'N/A'}</div>
                  <strong>Match ${i+1}:</strong> ${escapeHtml(m.name)}
                  <div style="font-size:12px;color:#666;margin-top:4px;">Similarity score for user review</div>
                </div>
              `).join("")}
            </div>
          </div>`
        : `<div class="section"><h3>No Significant Name Matches</h3><p style="color:#666;margin:0;">No entries above the similarity threshold.</p></div>`;

      const sourcesRow = `
        <div class="sources-row">
          <span class="source-chip">${ICONS.UN} UN</span>
          <span class="source-chip">${ICONS.EU} EU</span>
          <span class="source-chip">${ICONS.US} OFAC</span>
          <span class="source-chip">${ICONS.UK} HM Treasury</span>
        </div>
      `;

      el.report.innerHTML = `
        <div id="reportRoot" style="position:relative;">
          <div class="watermark">CONFIDENTIAL</div>

          <div class="report-header">
            <div class="report-title">
              <h2>Sanctions & PEP Screening Report</h2>
              <div class="report-ref">REF: ${ref}</div>
            </div>
            <div class="report-meta">
              <div><div class="meta-label">Generated</div><div class="meta-value">${generated}</div></div>
              <div><div class="meta-label">Performed by</div><div class="meta-value">${escapeHtml(user.fullname)}</div></div>
              <div><div class="meta-label">Source</div><div class="meta-value">${escapeHtml(s.Source || "United Nations; European Union; US OFAC; UK HM Treasury (OFSI)")}</div></div>
              <div><div class="meta-label">Status</div><div class="meta-value"><span class="status-badge ${statusBadge.class}">${statusBadge.icon} ${statusBadge.text}</span></div></div>
            </div>
          </div>

          <div class="report-body">
            <div class="section">
              <h3>Search Criteria</h3>
              <table class="kv-table">
                <tr><td class="key">Subject Name</td><td><strong>${escapeHtml(name)}</strong></td></tr>
                <tr><td class="key">Date of Birth</td><td>${dob || "Not provided"}</td></tr>
                <tr><td class="key">Entity Type</td><td>${escapeHtml(entity_type)}</td></tr>
                <tr><td class="key">Performed by</td><td>${escapeHtml(user.fullname)}</td></tr>
                <tr><td class="key">Search Reference</td><td><code class="mono">${ref}</code></td></tr>
              </table>
            </div>

            <div class="section">
              <h3>Compliance Summary</h3>
              <table class="kv-table">
                <tr><td class="key">Overall Status</td><td><span class="status-badge ${statusBadge.class}">${statusBadge.icon} ${statusBadge.text}</span></td></tr>
                <tr><td class="key">Risk Assessment</td><td><strong>${escapeHtml(data["Risk Level"] || "Low")}</strong></td></tr>
                <tr><td class="key">Confidence Level</td><td>${escapeHtml(data.Confidence || "Very High")}</td></tr>
                <tr><td class="key">Match Score</td><td>${data.Score ?? "0"}</td></tr>
                <tr><td class="key">Sanctions Listed</td><td><strong>${data["Is Sanctioned"] ? "YES" : "NO"}</strong></td></tr>
                <tr><td class="key">PEP Status</td><td><strong>${data["Is PEP"] ? "YES" : "NO"}</strong></td></tr>
              </table>
            </div>

            ${(data["Is Sanctioned"] || data["Is PEP"]) ? `
              <div class="section">
                <h3>Match Details</h3>
                <table class="kv-table">
                  <tr><td class="key">Matched Name</td><td><strong>${escapeHtml(data["Sanctions Name"] || "N/A")}</strong></td></tr>
                  <tr><td class="key">Birth Date</td><td>${escapeHtml(data["Birth Date"] || "Not available")}</td></tr>
                  <tr><td class="key">Sanctions Regime</td><td>${escapeHtml(data["Regime"] || "Not specified")}</td></tr>
                </table>
              </div>
            ` : ""}

            ${topMatchesHTML}

            <div class="section">
              <h3>Data Sources Queried</h3>
              ${sourcesRow}
              <div style="margin-top:8px;font-size:12px;color:#666;"><strong>Sources:</strong> ${escapeHtml(DATA_SOURCES_TEXT)}</div>
            </div>

            <div class="section">
              <h3>Audit Entity Record</h3>
              <table class="kv-table">
                <tr><td class="key">Entity ID</td><td><code class="mono">${escapeHtml(entityId || "Not returned")}</code></td></tr>
                <tr><td class="key">Search Reference</td><td><code class="mono">${ref}</code></td></tr>
                <tr><td class="key">Issued At (UTC)</td><td><code class="mono">${timestamp.toISOString()}</code></td></tr>
              </table>
              <div style="font-size:12px;color:#666;margin-top:6px;">Use Entity ID as the auditable record key to cross-check against the screened entity database.</div>
            </div>

            <div class="section">
              <div style="font-size:11px;color:#777;">
                Report generated by sanctions-check.co.uk client on ${generated}. This is not a legal record of identity. User review is required for any match.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function downloadPDF() {
      const root = document.getElementById("reportRoot");
      if (!root) { toast("Nothing to export yet.", true); return; }

      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          unit: "pt",
          format: "a4",
          putOnlyUsedFonts: true,
          compress: true
        });

        const margin = 24;
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        const user = getCurrentUserInfo();
        const ref = currentReport?.ref || "";
        const entityId = currentReport?.entityId || currentReport?.data?.entity_id || currentReport?.data?.entity_key || "";
        const issuedAt = currentReport?.timestamp?.toISOString() || new Date().toISOString();
        const subject = (document.getElementById("name").value || "").trim();
        const dob = (document.getElementById("dob").value || "").trim() || "Not provided";
        const entityType = (document.getElementById("etype").value || "").trim();
        const sources = (typeof DATA_SOURCES_TEXT !== "undefined" ? DATA_SOURCES_TEXT : "UN; EU; OFAC; UK HMT");

        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(18);
        pdf.text("Sanctions & PEP Screening Report", margin, margin + 6);

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.text("Generated by sanctions-check.co.uk", margin, margin + 26);

        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(12);
        pdf.text("Audit Summary (selectable text)", margin, margin + 56);

        const kv = [
          ["Entity ID", entityId || "Not returned"],
          ["Reference (REF)", ref],
          ["Issued At (UTC)", issuedAt],
          ["Performed by", user?.fullname || "Unknown"],
          ["Subject Name", subject],
          ["Date of Birth", dob],
          ["Entity Type", entityType],
          ["Data Sources", sources],
        ];

        const keyX = margin;
        const valX = margin + 160;
        let y = margin + 78;

        pdf.setFontSize(11);
        kv.forEach(([k, v]) => {
          pdf.setFont("helvetica", "bold");
          pdf.text(`${k}:`, keyX, y, { maxWidth: pageW - margin*2 });
          pdf.setFont("helvetica", "normal");
          const wrapped = pdf.splitTextToSize(String(v ?? ""), pageW - valX - margin);
          pdf.text(wrapped, valX, y, { maxWidth: pageW - valX - margin });
          const lines = Array.isArray(wrapped) ? wrapped.length : 1;
          y += 16 + (lines > 1 ? (lines - 1) * 12 : 0);
          if (y > pageH - margin - 40) { pdf.addPage(); y = margin; }
        });

        y += 10;
        pdf.setDrawColor(200);
        pdf.line(margin, y, pageW - margin, y);
        y += 20;
        pdf.setFontSize(10);
        pdf.text("Cover Page", margin, y, { maxWidth: pageW - margin*2 });

        const CAPTURE_SCALE = 1.2;
        const CONTENT_W_PCT = 0.92;
        const IMAGE_TYPE = "JPEG";
        const IMAGE_QUALITY = 0.72;

        const wm = root.querySelector('.watermark');
        const oldDisplay = wm?.style.display;
        if (wm) wm.style.display = 'none';

        const canvas = await html2canvas(root, {
          scale: CAPTURE_SCALE,
          useCORS: true,
          backgroundColor: "#ffffff"
        });

        if (wm) wm.style.display = oldDisplay || '';

        const downW = Math.floor(canvas.width * CONTENT_W_PCT);
        const downH = Math.floor(canvas.height * CONTENT_W_PCT);
        const downCanvas = document.createElement("canvas");
        downCanvas.width = downW;
        downCanvas.height = downH;
        const dctx = downCanvas.getContext("2d");
        dctx.imageSmoothingEnabled = true;
        dctx.imageSmoothingQuality = "high";
        dctx.drawImage(canvas, 0, 0, downW, downH);

        const imgData = downCanvas.toDataURL(`image/${IMAGE_TYPE.toLowerCase()}`, IMAGE_QUALITY);

        const usableW = pageW - margin * 2;
        const usableH = pageH - margin * 2;
        const imgW = usableW;
        const imgH = (downH * imgW) / downW;

        pdf.addPage();

        if (imgH <= usableH) {
          pdf.addImage(imgData, IMAGE_TYPE, margin, margin, imgW, imgH);
        } else {
          const sliceHpx = Math.floor((usableH * downW) / imgW);
          const pageCanvas = document.createElement("canvas");
          const pctx = pageCanvas.getContext("2d");
          pageCanvas.width = downW;
          pageCanvas.height = sliceHpx;

          let ySrc = 0;
          let first = true;
          while (ySrc < downH) {
            pctx.clearRect(0, 0, pageCanvas.width, pageCanvas.height);
            pctx.drawImage(downCanvas, 0, -ySrc);
            const pageImg = pageCanvas.toDataURL(`image/${IMAGE_TYPE.toLowerCase()}`, IMAGE_QUALITY);
            if (!first) pdf.addPage();
            pdf.addImage(pageImg, IMAGE_TYPE, margin, margin, imgW, usableH);
            ySrc += sliceHpx;
            first = false;
          }
        }

        const safeName = (subject || "sanctions_check").replace(/[^\w.-]+/g, "_");
        const prefix = (user?.fullname || "").replace(/[^\w.-]+/g, "_");
        const refPart = ref ? `${ref}_` : "";
        const fileName = `${prefix ? prefix + "_" : ""}${refPart}${safeName}.pdf`;

        pdf.setProperties({
          title: `Sanctions & PEP Report - ${subject}`,
          subject: "Compliance screening",
          author: user?.fullname || "Sanctions Client",
          keywords: `sanctions,pep,compliance,ref:${ref},entity_id:${entityId}`,
          creator: "sanctions-check.co.uk"
        });

        pdf.save(fileName);
      } catch (e) {
        console.error(e);
        toast("PDF generation failed.", true);
      }
    }

    function toast(msg, isErr=false) {
      el.status.textContent = msg;
      el.status.classList.toggle("error", !!isErr);
      el.status.classList.toggle("success", !isErr);
    }

    function setBusy(b) {
      el.runBtn.disabled = b;
      el.pdfBtn.disabled = b || el.pdfBtn.disabled;
      el.clearBtn.disabled = b;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");
    }

  </script>
</body>
</html>
